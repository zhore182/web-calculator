---
phase: 02-scientific-functions
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/logic/cursorHelpers.ts
  - src/logic/cursorHelpers.test.ts
  - src/App.tsx
  - src/components/Display.tsx
  - src/components/Calculator.tsx
  - src/styles/Calculator.css
autonomous: true

must_haves:
  truths:
    - "Pressing sin button with '45' in expression produces 'sin(45)' (smart wrap)"
    - "Pressing sin button with empty expression produces 'sin(' at cursor"
    - "Pressing pi button inserts pi symbol into expression"
    - "DEG/RAD badge visible in display corner, clicking toggles angle mode"
    - "Switching angle mode re-evaluates current expression immediately"
    - "Function names display in lowercase in expression line"
  artifacts:
    - path: "src/logic/cursorHelpers.ts"
      provides: "insertFunction with smart auto-wrap, insertConstant"
      exports: ["insertFunction", "insertConstant"]
    - path: "src/components/Display.tsx"
      provides: "DEG/RAD badge in display area"
      contains: "angle-badge"
    - path: "src/App.tsx"
      provides: "Angle mode state, function input handling, re-evaluation on mode toggle"
      contains: "angleMode"
  key_links:
    - from: "src/App.tsx"
      to: "src/logic/expressionParser.ts"
      via: "evaluateExpression with angleMode parameter"
      pattern: "evaluateExpression.*angleMode"
    - from: "src/App.tsx"
      to: "src/logic/cursorHelpers.ts"
      via: "insertFunction for smart wrap"
      pattern: "insertFunction"
    - from: "src/components/Display.tsx"
      to: "src/App.tsx"
      via: "onAngleModeToggle callback"
      pattern: "onAngleModeToggle"
---

<objective>
Add function input with smart auto-wrap, constant insertion, and DEG/RAD angle mode toggle to the calculator.

Purpose: Users need to input scientific functions (sin, cos, log, etc.) and constants (pi, e) into expressions, with smart behavior that wraps existing numbers. The DEG/RAD toggle is essential for trig functions to produce expected results.

Output: Working function input via button values, constant insertion, smart auto-wrap behavior, clickable DEG/RAD badge in display, and angle mode state wired through evaluation.
</objective>

<execution_context>
@/Users/angel-ai/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angel-ai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-scientific-functions/02-01-SUMMARY.md
@src/logic/cursorHelpers.ts
@src/logic/cursorHelpers.test.ts
@src/App.tsx
@src/components/Display.tsx
@src/components/Calculator.tsx
@src/styles/Calculator.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Function input helpers with smart auto-wrap and constant insertion</name>
  <files>src/logic/cursorHelpers.ts, src/logic/cursorHelpers.test.ts</files>
  <action>
Add two new functions to cursorHelpers.ts:

**`insertFunction(expression: string, cursorPosition: number, funcName: string): { expression: string; cursorPosition: number }`**

Smart auto-wrap behavior (per user decision):
1. Check if there's a completed number immediately before the cursor position. A "completed number" is a sequence of digits (possibly with decimal point) that ends right at cursor position, e.g., `"45|"` or `"3.14|"`.
2. If a number exists before cursor → wrap it: `sin(45)` with cursor after closing paren.
   - Extract the number by scanning backwards from cursor position until non-digit/non-decimal character found.
   - Replace: `expression[0..numStart] + funcName + "(" + number + ")" + expression[cursorPos..]`
   - New cursor position: after the closing paren
3. If no number before cursor → insert `funcName + "(` with auto-close `)`: `sin(|)` with cursor between parens.
   - This follows the existing auto-close parenthesis pattern from Phase 1.

Function name should be lowercase (per user decision): `sin`, `cos`, `tan`, `asin`, `acos`, `atan`, `sinh`, `cosh`, `tanh`, `log`, `ln`, `sqrt`, `cbrt`, `abs`.

**`insertConstant(expression: string, cursorPosition: number, constant: string): { expression: string; cursorPosition: number }`**

Insert a constant (pi or e) at cursor position:
- `constant` is the display string: `"pi"` or `"e"`
- Per user decision: Pi displays as `pi` in expression (mathjs evaluates `pi` natively)
- Per user decision: `e` displays as `e` in expression (mathjs evaluates `e` natively)
- Implicit multiplication handled by mathjs: `2pi` evaluates as `2*pi`
- Simply insert the constant string at cursor position using `insertAtCursor`.

**Tests to write:**

`insertFunction` tests:
- Empty expression + sin → `sin()` with cursor at position 4 (between parens)
- `"45"` at cursor 2 + sin → `sin(45)` with cursor at 7
- `"2+45"` at cursor 4 + cos → `2+cos(45)` with cursor at 9
- `"2+"` at cursor 2 + tan → `2+tan()` with cursor at 6 (no number before cursor after +)
- `"3.14"` at cursor 4 + sin → `sin(3.14)` with cursor at 9
- `"2+3*"` at cursor 4 + log → `2+3*log()` with cursor at 9
- Expression with number and cursor in middle, e.g., `"123+456"` cursor at 3 → should wrap `123`: `sin(123)+456`

`insertConstant` tests:
- Empty expression + pi → `pi` with cursor at 2
- `"2"` at cursor 1 + pi → `2pi` with cursor at 3
- `"2+"` at cursor 2 + e → `2+e` with cursor at 3

Run tests, ensure they pass.
  </action>
  <verify>
Run `npx vitest run src/logic/cursorHelpers.test.ts` — all tests pass (existing 40 + new ~15).
Run `npm run build` — no TypeScript errors.
  </verify>
  <done>
`insertFunction` correctly implements smart auto-wrap (wraps existing number or inserts empty function call). `insertConstant` inserts constant at cursor. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: DEG/RAD badge, angle mode state, and function input wiring in App</name>
  <files>src/App.tsx, src/components/Display.tsx, src/components/Calculator.tsx, src/styles/Calculator.css</files>
  <action>
**Display.tsx — Add DEG/RAD badge:**

Add new props to DisplayProps:
```typescript
angleMode?: 'DEG' | 'RAD';
onAngleModeToggle?: () => void;
```

Render a small clickable badge in the top-right corner of the display area (per user decision: "lives in the display area as a small indicator/badge in a corner"):
```tsx
{angleMode && (
  <button
    className="display__angle-badge"
    onClick={onAngleModeToggle}
    aria-label={`Angle mode: ${angleMode}. Click to toggle.`}
  >
    {angleMode}
  </button>
)}
```

The badge should only appear when in expression mode (scientific functions are expression-mode only).

Also update `renderExpression()` to handle pi symbol display: replace `pi` in expressions with `π` for display only (internal expression stays as `pi` for mathjs). Be careful with regex to not match `asin` → `aπn` — use word boundary: `/\bpi\b/g` → `π`.

**Calculator.tsx — Wire new props:**

Add to CalculatorProps:
```typescript
angleMode: 'DEG' | 'RAD';
onAngleModeToggle: () => void;
```

Pass `angleMode` and `onAngleModeToggle` to Display component.

**App.tsx — Angle mode state and function input:**

1. Add angle mode state:
```typescript
const [angleMode, setAngleMode] = useState<AngleMode>('DEG'); // Default DEG per user decision
```

Import `AngleMode` from expressionParser.ts.

2. Add angle mode toggle handler:
```typescript
const handleAngleModeToggle = useCallback(() => {
  setAngleMode(prev => {
    const newMode = prev === 'DEG' ? 'RAD' : 'DEG';
    // Per user decision: switching angle mode immediately re-evaluates
    if (expression) {
      const result = evaluateExpression(expression, newMode);
      if (result.status === 'success' && result.display) {
        setPreviewResult(result.display);
      }
    }
    return newMode;
  });
}, [expression]);
```

3. Update ALL existing `evaluateExpression()` calls to pass `angleMode` parameter. Search for every `evaluateExpression(` in App.tsx and add the angleMode argument.

4. Add function input handling in the expression mode block. When a function button value is received (e.g., `"sin"`, `"cos"`, `"log"`, `"sqrt"`, etc.), call `insertFunction`:
```typescript
// Handle scientific function input
const scientificFunctions = ['sin', 'cos', 'tan', 'asin', 'acos', 'atan',
  'sinh', 'cosh', 'tanh', 'asinh', 'acosh', 'atanh',
  'log', 'ln', 'sqrt', 'cbrt', 'abs'];

if (scientificFunctions.includes(value)) {
  const { expression: newExpr, cursorPosition: newCursor } = insertFunction(expression, cursorPosition, value);
  setExpression(newExpr);
  setCursorPosition(newCursor);
  // Try live preview
  const result = evaluateExpression(newExpr, angleMode);
  if (result.status === 'success' && result.display) {
    setPreviewResult(result.display);
  } else {
    setPreviewResult('');
  }
  return;
}
```

5. Add constant input handling. When `"pi"` or `"e"` button value is received:
```typescript
if (value === 'pi' || value === 'e_constant') {
  const constantStr = value === 'pi' ? 'pi' : 'e';
  const { expression: newExpr, cursorPosition: newCursor } = insertConstant(expression, cursorPosition, constantStr);
  setExpression(newExpr);
  setCursorPosition(newCursor);
  // Try live preview
  const result = evaluateExpression(newExpr, angleMode);
  if (result.status === 'success' && result.display) {
    setPreviewResult(result.display);
  } else {
    setPreviewResult('');
  }
  return;
}
```

Use `"e_constant"` as button value to avoid collision with the letter `e` in keyboard input.

6. Add factorial (`!`) and percentage (`%`) input handling — these are operator-like characters appended at cursor:
```typescript
if (value === '!' || value === '%') {
  const { expression: newExpr, cursorPosition: newCursor } = insertAtCursor(expression, cursorPosition, value);
  setExpression(newExpr);
  setCursorPosition(newCursor);
  const result = evaluateExpression(newExpr, angleMode);
  if (result.status === 'success' && result.display) {
    setPreviewResult(result.display);
  } else {
    setPreviewResult('');
  }
  return;
}
```

7. Add power operator (`^`) input handling — inserted as `^` character:
```typescript
if (value === '^') {
  const { expression: newExpr, cursorPosition: newCursor } = insertAtCursor(expression, cursorPosition, '^');
  setExpression(newExpr);
  setCursorPosition(newCursor);
  const result = evaluateExpression(newExpr, angleMode);
  if (result.status === 'success' && result.display) {
    setPreviewResult(result.display);
  } else {
    setPreviewResult('');
  }
  return;
}
```

8. Pass angleMode and onAngleModeToggle to Calculator component.

**Calculator.css — Style the DEG/RAD badge:**

```css
.display__angle-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(100, 100, 100, 0.2);
  border: 1px solid rgba(100, 100, 100, 0.3);
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 0.7rem;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  transition: background-color 0.15s;
  z-index: 1;
  line-height: 1;
}

.display__angle-badge:hover {
  background: rgba(100, 100, 100, 0.35);
}
```

Ensure the `.display` container has `position: relative` for the badge positioning.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors.
Run `npx vitest run` — all tests pass (no regressions).
Verify in dev server (`npm run dev`):
- DEG badge appears in display corner when in expression mode
- Clicking DEG toggles to RAD and back
- Typing a number then triggering a function button value wraps it
- Pi and e constants can be inserted
- Angle mode change re-evaluates expression preview
  </verify>
  <done>
DEG/RAD badge visible and clickable in display. Angle mode state flows through all evaluation calls. Function input with smart auto-wrap works. Constants insert correctly. Expression line renders `pi` as `π`. All tests pass, build succeeds.
  </done>
</task>

</tasks>

<verification>
- `npm run build` — no TypeScript errors
- `npx vitest run` — all tests pass
- DEG/RAD badge renders in display top-right corner
- Badge click toggles between DEG and RAD
- In expression mode: type "45" then trigger sin button → expression shows "sin(45)"
- In expression mode: trigger sin button on empty → expression shows "sin()"
- Pi button inserts `pi` (displayed as `π`)
- Switching DEG/RAD re-evaluates current expression
</verification>

<success_criteria>
Function input with smart auto-wrap inserts functions correctly. Constants (pi, e) insertable. DEG/RAD badge visible, clickable, and toggles angle mode. Angle mode flows through evaluation. Display renders pi as symbol. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-scientific-functions/02-02-SUMMARY.md`
</output>
