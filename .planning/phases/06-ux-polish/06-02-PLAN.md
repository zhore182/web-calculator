---
phase: 06-ux-polish
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/hooks/useKeyboardInput.ts
  - src/hooks/useKeyboardInput.test.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can copy the current result to clipboard with Ctrl+C / Cmd+C"
    - "User can paste an expression from clipboard with Ctrl+V / Cmd+V"
    - "Pasted text appears at cursor position in expression mode"
    - "User can type ^ for exponentiation via keyboard"
    - "User can type ! for factorial via keyboard"
    - "User can type % for percentage via keyboard"
  artifacts:
    - path: "src/hooks/useKeyboardInput.ts"
      provides: "Clipboard and special character keyboard support"
      exports: ["useKeyboardInput"]
    - path: "src/App.tsx"
      provides: "Paste handler for expression insertion"
  key_links:
    - from: "src/hooks/useKeyboardInput.ts"
      to: "src/App.tsx"
      via: "onButtonClick('paste:...') for paste, onButtonClick('^') for caret"
      pattern: "paste:|\\^|!|%"
    - from: "src/App.tsx"
      to: "navigator.clipboard"
      via: "copy handler reads displayValue/previewResult"
      pattern: "clipboard"
---

<objective>
Add clipboard copy/paste support and keyboard shortcuts for scientific operators (^, !, %).

Purpose: Complete UI-03 and UI-04 requirements — users can copy results, paste expressions, and type all scientific operators from keyboard.
Output: Full keyboard-driven workflow for copy/paste and scientific input.
</objective>

<execution_context>
@/Users/angel-ai/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angel-ai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-polish/06-01-SUMMARY.md
@src/hooks/useKeyboardInput.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy/paste clipboard support</name>
  <files>src/hooks/useKeyboardInput.ts, src/App.tsx</files>
  <action>
1. **useKeyboardInput.ts** — Modify the keyboard hook to handle Ctrl/Cmd shortcuts BEFORE the generic guard:

   Currently the hook has `if (e.ctrlKey || e.altKey || e.metaKey) return;` which blocks ALL modifier shortcuts. Change this to:

   ```typescript
   // Handle copy/paste before blocking other modifier keys
   if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
     e.preventDefault();
     onButtonClick('copy');
     return;
   }
   if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
     e.preventDefault();
     onButtonClick('paste');
     return;
   }

   // Block other modifier combos (Alt+Tab, Ctrl+Z, etc.)
   if (e.ctrlKey || e.altKey || e.metaKey) return;
   ```

   Note: The `e.target` INPUT/TEXTAREA guard runs before this, so copy/paste in the graph input field still works natively.

2. **App.tsx** — Add copy and paste handlers in `handleButtonClick`:

   **Copy handler** (add before the expression mode block):
   ```
   if (value === 'copy') {
     // Copy the most relevant value: previewResult if available, else displayValue
     const textToCopy = (expressionMode === 'expression' && previewResult && previewResult !== 'Syntax Error')
       ? previewResult
       : displayValue;
     navigator.clipboard.writeText(textToCopy);
     return;
   }
   ```

   **Paste handler** (add right after copy handler):
   ```
   if (value === 'paste') {
     navigator.clipboard.readText().then(text => {
       if (!text) return;
       // Clean pasted text: only allow valid math characters
       const cleaned = text.replace(/[^0-9+\-*/().^!%a-z ]/gi, '').trim();
       if (!cleaned) return;

       if (expressionMode === 'expression') {
         // Insert at cursor position
         const newExpr = expression.slice(0, cursorPosition) + cleaned + expression.slice(cursorPosition);
         setExpression(newExpr);
         setCursorPosition(cursorPosition + cleaned.length);
         // Try live preview
         const result = evaluateExpression(newExpr, angleMode);
         if (result.status === 'success' && result.display) {
           setPreviewResult(result.display);
         } else {
           setPreviewResult('');
         }
       } else {
         // Simple mode: if pasted text is a valid number, set as display value
         const num = parseFloat(cleaned);
         if (!isNaN(num)) {
           setDisplayValue(String(num));
         }
       }
     });
     return;
   }
   ```
  </action>
  <verify>Run `npm run build` — no TypeScript errors. In browser: type "2+3=", Ctrl+C copies "5" to clipboard. Switch to expression mode, Ctrl+V pastes clipboard content at cursor.</verify>
  <done>Ctrl/Cmd+C copies current result. Ctrl/Cmd+V pastes expression text at cursor in expression mode or sets display value in simple mode. Pasted text is sanitized.</done>
</task>

<task type="auto">
  <name>Task 2: Keyboard shortcuts for ^, !, % operators</name>
  <files>src/hooks/useKeyboardInput.ts</files>
  <action>
Add keyboard mappings for the three missing scientific operators in useKeyboardInput.ts:

1. Add to the `keyMap` object:
   ```
   '^': '^',    // Shift+6 for exponentiation
   '!': '!',    // Shift+1 for factorial
   '%': '%',    // Shift+5 for percentage
   ```

   These keys are produced by Shift+number combinations on standard keyboards. The existing handler in App.tsx already processes '^', '!', and '%' values in expression mode (lines ~304-330), so no App.tsx changes needed for this task.

2. Verify the existing keyboard hook doesn't block Shift key — check that the guard `if (e.ctrlKey || e.altKey || e.metaKey) return;` does NOT include `e.shiftKey`. Current code: correct, Shift is not blocked.

3. Update useKeyboardInput.test.ts — add test cases:
   - Pressing '^' key calls onButtonClick('^')
   - Pressing '!' key calls onButtonClick('!')
   - Pressing '%' key calls onButtonClick('%')
  </action>
  <verify>Run `npx vitest run src/hooks/useKeyboardInput.test.ts` — all tests pass including new ^ ! % tests.</verify>
  <done>Users can type ^ (Shift+6), ! (Shift+1), % (Shift+5) from keyboard. These are routed through existing App.tsx handlers for expression mode.</done>
</task>

</tasks>

<verification>
- `npx vitest run` — all tests pass
- `npm run build` — builds without errors
- Copy: In expression mode, evaluate "sin(45)", Ctrl+C copies result
- Paste: Copy "2+3*4", Ctrl+V in expression mode inserts at cursor
- Keyboard: In expression mode, type "2^3" using keyboard, get "8"
- Keyboard: Type "5!" using keyboard, get "120"
- Keyboard: Type "50%" using keyboard, get "0.5"
</verification>

<success_criteria>
1. Ctrl/Cmd+C copies result to clipboard from either mode
2. Ctrl/Cmd+V pastes and sanitizes text into expression at cursor
3. ^, !, % keys work from keyboard in expression mode
4. All existing tests pass, new keyboard tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-polish/06-02-SUMMARY.md`
</output>
