---
phase: 06-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/logic/expressionParser.ts
  - src/logic/expressionParser.test.ts
  - src/logic/operationHandlers.ts
  - src/components/ButtonPanel.tsx
  - src/App.tsx
  - src/styles/Calculator.css
autonomous: true

must_haves:
  truths:
    - "Very large numbers (e.g., 10^20) display in scientific notation automatically"
    - "Very small numbers (e.g., 0.000000001) display in scientific notation automatically"
    - "Normal-range numbers still display normally (no scientific notation for 42)"
    - "CE clears current input while preserving operator and previous value"
    - "C resets the entire calculator state to initial"
    - "In expression mode, CE clears expression but keeps last result in display"
  artifacts:
    - path: "src/logic/expressionParser.ts"
      provides: "Updated formatResult with scientific notation"
      exports: ["evaluateExpression", "formatResult"]
    - path: "src/components/ButtonPanel.tsx"
      provides: "CE button added to button grid"
      contains: "CE"
  key_links:
    - from: "src/logic/expressionParser.ts"
      to: "display output"
      via: "formatResult called on every evaluation"
      pattern: "formatResult"
    - from: "src/components/ButtonPanel.tsx"
      to: "src/App.tsx"
      via: "onButtonClick('CE') handler"
      pattern: "CE"
---

<objective>
Add scientific notation display for extreme numbers and split Clear into CE (clear entry) and C (clear all).

Purpose: Complete EXPR-04 and UI-02 requirements — users see readable notation for extreme values and have granular control over clearing.
Output: Updated formatResult with auto-scientific notation, CE/C button split with distinct behaviors.
</objective>

<execution_context>
@/Users/angel-ai/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angel-ai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/logic/expressionParser.ts
@src/logic/operationHandlers.ts
@src/components/ButtonPanel.tsx
@src/App.tsx
@src/styles/Calculator.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scientific notation in formatResult</name>
  <files>src/logic/expressionParser.ts, src/logic/expressionParser.test.ts</files>
  <action>
Update `formatResult()` in expressionParser.ts to automatically display scientific notation for very large or very small numbers:

1. After the existing `toPrecision(12) + parseFloat` formatting, check if the absolute value meets threshold criteria:
   - If `abs(value) >= 1e12` OR (`abs(value) < 1e-6` AND `value !== 0`): use `toExponential()` notation
   - Otherwise: keep current formatting (normal decimal display)

2. For scientific notation display, format as `N.NNe+XX` or `N.NNe-XX`:
   - Use `value.toExponential(6)` for readable precision (6 significant digits after decimal)
   - Then clean up trailing zeros in the mantissa: e.g., `1.000000e+15` becomes `1e+15`

3. Add tests in expressionParser.test.ts:
   - `formatResult(1e15)` returns scientific notation string (e.g., "1e+15")
   - `formatResult(0.0000001)` returns scientific notation (e.g., "1e-7")
   - `formatResult(42)` returns "42" (no scientific notation for normal numbers)
   - `formatResult(999999999999)` returns normal decimal (just under threshold)
   - `formatResult(1000000000000)` returns scientific notation (at threshold)
   - `formatResult(0)` returns "0" (zero is NOT scientific notation)
   - `formatResult(-1e15)` returns negative scientific notation

Note: The threshold of 1e12 aligns with the 12-digit toPrecision already used. Numbers that would need more than 12 digits to represent go to scientific notation.
  </action>
  <verify>Run `npx vitest run src/logic/expressionParser.test.ts` — all tests pass including new scientific notation tests.</verify>
  <done>formatResult returns scientific notation for |value| >= 1e12 or |value| < 1e-6, normal format otherwise. All existing and new tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: CE/C button split with distinct clear behaviors</name>
  <files>src/components/ButtonPanel.tsx, src/App.tsx, src/styles/Calculator.css</files>
  <action>
1. **ButtonPanel.tsx** — Update the button layout to include CE alongside C:
   - Change the row `['C', '', '', '/']` to `['C', 'CE', '', '/']`
   - Add styling class for CE: `if (label === 'CE') return 'btn--clear';` (same style as C)

2. **App.tsx** — Add CE handler in `handleButtonClick`:
   - Add a new case BEFORE the existing 'C' handler:
   ```
   if (value === 'CE') {
     if (expressionMode === 'expression') {
       // CE in expression mode: clear expression, keep last display value
       setExpression('');
       setCursorPosition(0);
       setPreviewResult('');
       // Do NOT reset displayValue — keep last result visible
     } else {
       // CE in simple mode: reset display to '0' but preserve previousValue and operator
       setDisplayValue('0');
       setWaitingForOperand(false);
     }
     return;
   }
   ```
   - The existing 'C' handler already resets everything (full clear), which is correct for "Clear All"

3. **useKeyboardInput.ts** — Add keyboard mapping for CE:
   - Map 'Delete' key to 'CE' (Delete key is intuitive for "clear entry" vs Escape for "clear all")
   - Add to keyMap: `'Delete': 'CE'`

4. **Behavioral distinction:**
   - **CE (Clear Entry):** In simple mode, resets displayValue to '0' but keeps previousValue/operator intact so the pending operation is preserved. In expression mode, clears the expression but keeps the last computed result in the display line.
   - **C (Clear All):** Full reset — displayValue='0', previousValue=null, operator=null (existing behavior unchanged).
  </action>
  <verify>Run `npm run build` — no TypeScript errors. Manually verify: type "5 + 3", press CE, display shows "0" but pressing "7 =" gives "12" (5+7). Press C — everything resets.</verify>
  <done>CE button visible in button grid. CE clears current input preserving pending operation. C resets entire calculator. Delete key maps to CE, Escape maps to C.</done>
</task>

</tasks>

<verification>
- `npx vitest run` — all tests pass
- `npm run build` — builds without errors
- Scientific notation: evaluate `10^20` in expression mode, result displays in scientific notation
- Normal numbers: evaluate `2+3`, result displays as "5" (not scientific)
- CE in simple mode: enter "5 + 3", press CE, enter "7 =", get "12"
- C in simple mode: enter "5 + 3", press C, all state reset
- CE in expression mode: type expression, press CE, expression clears but last result stays
</verification>

<success_criteria>
1. formatResult automatically uses scientific notation for |value| >= 1e12 or |value| < 1e-6
2. CE button appears in button panel and clears current entry only
3. C button continues to reset entire calculator state
4. All existing tests pass, new scientific notation tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-polish/06-01-SUMMARY.md`
</output>
