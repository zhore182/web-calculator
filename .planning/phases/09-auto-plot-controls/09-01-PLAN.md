---
phase: 09-auto-plot-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/components/GraphPanel.tsx
  - src/components/Calculator.tsx
  - src/styles/Calculator.css
autonomous: false

must_haves:
  truths:
    - "Switching to graph mode with an expression containing x auto-plots it"
    - "Switching to graph mode with an expression NOT containing x shows empty graph (no plot of constant)"
    - "Graph controls (zoom +/-, reset, table) are visible as overlays and do not obscure the graph canvas or expression display"
    - "User can zoom, pan, and trace without leaving graph mode"
    - "Trace readout shows coordinates when hovering over graph in graph mode"
  artifacts:
    - path: "src/App.tsx"
      provides: "x-detection logic in handleModeSelect and useEffect sync"
      contains: "containsVariable"
    - path: "src/components/Calculator.tsx"
      provides: "Graph-mode hint when expression has no x"
    - path: "src/styles/Calculator.css"
      provides: "Graph-mode control positioning polish"
      contains: "graph-panel__hint"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/GraphPanel.tsx"
      via: "graphExpression prop (only set when expression contains x)"
      pattern: "containsVariable.*setGraphExpression"
    - from: "src/components/Calculator.tsx"
      to: "src/components/GraphPanel.tsx"
      via: "expression and visible props in graph mode layout"
      pattern: "calculator__graph-main"
---

<objective>
Add x-variable detection to auto-plot logic and polish graph-mode control overlay positioning.

Purpose: Phase 8 built the mode toggle and live expression sync, but it plots ANY expression (including constants like "2+3"). The INTG-02 requirement specifies auto-plot should only activate when the expression contains variable x. Additionally, graph controls need minor positioning polish for the larger graph-mode canvas to satisfy INTG-05.

Output: Refined auto-plot with x-detection, user hint for non-graphable expressions, polished control overlays in graph mode.
</objective>

<execution_context>
@/Users/angel-ai/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angel-ai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-layout-integration/08-01-SUMMARY.md
@src/App.tsx
@src/components/Calculator.tsx
@src/components/GraphPanel.tsx
@src/styles/Calculator.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add x-variable detection to auto-plot and expression sync</name>
  <files>src/App.tsx, src/components/Calculator.tsx, src/styles/Calculator.css</files>
  <action>
1. In src/App.tsx, create a helper function `containsVariable(expr: string): boolean` that checks if an expression contains the variable `x`. It should match standalone `x` but NOT match `x` inside function names like `exp`, `max`, `nthRoot`. Use a regex like `/(?<![a-z])x(?![a-z])/i` — matches `x` not preceded or followed by a letter. Place this above the App component.

2. Update `handleModeSelect` in App.tsx: In the `mode === 'graph'` branch (around line 115-117), wrap the `setGraphExpression(expression)` call with the check:
   ```
   if (expression && containsVariable(expression)) {
     setGraphExpression(expression);
   } else {
     setGraphExpression('');  // Clear graph — don't plot constants
   }
   ```

3. Update the `useEffect` for live expression sync (around line 60-64): Change the condition so it only syncs when the expression contains x:
   ```
   useEffect(() => {
     if (appMode === 'graph') {
       if (expression && containsVariable(expression)) {
         setGraphExpression(expression);
       } else {
         setGraphExpression('');
       }
     }
   }, [appMode, expression]);
   ```

4. In Calculator.tsx, add a hint message inside the `calculator__graph-main` div, shown when in graph mode and graphExpression is empty but expression is non-empty (user typed something without x). Add it just before the GraphPanel:
   ```tsx
   {isGraphMode && !graphExpression && expression && (
     <div className="graph-panel__hint">
       Type an expression with x to plot (e.g. sin(x), x^2)
     </div>
   )}
   ```

5. In Calculator.css, add styles for `.graph-panel__hint`:
   ```css
   .graph-panel__hint {
     color: var(--color-text-muted);
     font-size: var(--font-size-sm);
     text-align: center;
     padding: var(--space-4) var(--space-3);
     font-style: italic;
   }
   ```
  </action>
  <verify>Run `npm run build` — zero errors. Verify containsVariable returns true for "x^2", "sin(x)", "2*x+1", "x" and false for "2+3", "exp(2)", "max(1,2)", "".</verify>
  <done>Switching to graph mode only auto-plots expressions containing x. Expressions without x show a hint message and empty graph. Live sync respects the same x-detection rule.</done>
</task>

<task type="auto">
  <name>Task 2: Polish graph control overlay positioning for graph mode</name>
  <files>src/styles/Calculator.css, src/components/GraphPanel.tsx</files>
  <action>
1. In Calculator.css, add graph-mode-specific overrides for the control overlay positioning to ensure controls don't overlap the expression display area. Add after the existing `.calculator--graph-mode .graph-panel__canvas` rule (around line 632):
   ```css
   /* Graph controls positioning in graph mode — more breathing room */
   .calculator--graph-mode .graph-panel__controls {
     top: var(--space-3);
     right: var(--space-3);
   }

   /* Trace readout in graph mode — ensure it doesn't overlap controls */
   .calculator--graph-mode .graph-panel__trace-readout {
     bottom: var(--space-4);
     left: var(--space-4);
     font-size: var(--font-size-xs);
   }
   ```

2. In GraphPanel.tsx, add `aria-label` attributes to the control buttons for accessibility:
   - Zoom in button: `aria-label="Zoom in"`
   - Zoom out button: `aria-label="Zoom out"`
   - Reset button: `aria-label="Reset view"`
   - Table toggle button: `aria-label="Toggle function table"`

3. Also in GraphPanel.tsx, ensure the graph canvas has `role="img"` and `aria-label` for screen readers:
   ```tsx
   <canvas
     ref={canvasRef}
     className={canvasClassName}
     style={{ width: '100%', height: '200px' }}
     role="img"
     aria-label={expression ? `Graph of y = ${expression}` : 'Empty graph'}
     ...existing handlers...
   />
   ```
  </action>
  <verify>Run `npm run build` — zero errors. Visually inspect that controls are positioned with appropriate spacing in both calc-mode graph panel and graph-mode graph panel.</verify>
  <done>Graph controls have appropriate spacing in graph mode, trace readout doesn't overlap controls, all interactive elements have aria-labels for accessibility.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify auto-plot and graph controls</name>
  <files>src/App.tsx, src/components/Calculator.tsx, src/components/GraphPanel.tsx, src/styles/Calculator.css</files>
  <action>
Human verification of auto-plot with x-variable detection and polished graph-mode controls:
1. Only expressions containing x are auto-plotted in graph mode
2. Hint message shown when expression doesn't contain x
3. Controls positioned cleanly in graph mode
4. Accessible labels on all graph controls

Steps to verify:
1. Open the calculator in the browser (npm run dev if not running)
2. Type "2+3" in expression mode, then switch to Graph mode — Expected: Empty graph with hint "Type an expression with x to plot", expression display shows "2+3" at the top
3. Now type "x^2" in the expression input — Expected: Graph immediately shows x^2 parabola (live sync)
4. Clear and type "sin(x)" — Expected: Graph updates to show sine wave
5. Verify zoom controls (+/-) work — click them
6. Verify reset button returns to default viewport
7. Hover over the graph — trace readout should show coordinates at bottom-left
8. Verify controls don't overlap the expression display area or graph content
9. Switch back to Simple mode — graph should disappear
10. Switch back to Graph with empty expression — should show empty graph (no hint, since no expression typed)
  </action>
  <verify>User confirms all 10 verification steps pass by typing "approved"</verify>
  <done>All four phase success criteria verified by human testing: auto-plot with x-detection, accessible controls, non-overlapping layout, in-mode interaction</done>
</task>

</tasks>

<verification>
- `npm run build` produces zero errors
- containsVariable correctly identifies x in expressions while ignoring x inside function names
- Graph mode with "x^2" shows parabola; with "2+3" shows empty graph + hint
- Controls are visible, non-overlapping, and accessible
- All four success criteria from ROADMAP are met
</verification>

<success_criteria>
1. Switching to graph mode auto-plots the current expression if and only if it contains variable x
2. Graph controls (zoom, pan, trace) are accessible as overlays in graph mode
3. Controls do not obscure the graph or expression display
4. User can interact with controls without leaving graph mode
</success_criteria>

<output>
After completion, create `.planning/phases/09-auto-plot-controls/09-01-SUMMARY.md`
</output>
