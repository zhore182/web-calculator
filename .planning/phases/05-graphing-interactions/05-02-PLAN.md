---
phase: 05-graphing-interactions
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/logic/graphRenderer.ts
  - src/logic/graphRenderer.test.ts
  - src/components/GraphPanel.tsx
  - src/components/FunctionTable.tsx
  - src/components/Calculator.tsx
  - src/styles/Calculator.css
autonomous: false

must_haves:
  truths:
    - "User can hover/move over the graph curve and see exact x,y coordinates displayed"
    - "Trace dot visually marks the point on the curve being inspected"
    - "User can view a function table showing x/y value pairs for the current viewport range"
    - "Function table updates when viewport changes (zoom/pan)"
  artifacts:
    - path: "src/logic/graphRenderer.ts"
      provides: "Trace point rendering function and table data generation"
      contains: "renderTracePoint"
    - path: "src/components/GraphPanel.tsx"
      provides: "Mouse move trace handler, trace coordinate display, table toggle"
      contains: "tracePoint"
    - path: "src/components/FunctionTable.tsx"
      provides: "Scrollable table of x/y value pairs"
      contains: "FunctionTable"
  key_links:
    - from: "src/components/GraphPanel.tsx"
      to: "src/logic/graphRenderer.ts"
      via: "sampleFunction for trace evaluation, generateTableData for table"
      pattern: "generateTableData"
    - from: "src/components/Calculator.tsx"
      to: "src/components/FunctionTable.tsx"
      via: "Renders FunctionTable below GraphPanel when toggled"
      pattern: "FunctionTable"
---

<objective>
Add curve tracing (hover to see x,y coordinates) and a function table (x/y value pairs) to the graph, completing all Phase 5 interaction features.

Purpose: Users need to inspect exact values on plotted curves and view tabular data for the function. Trace provides point-by-point inspection; the table gives a systematic overview of values across the viewport range.

Output: Mouse-move trace with coordinate readout and dot marker, toggleable function table component.
</objective>

<execution_context>
@/Users/angel-ai/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angel-ai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-graphing-interactions/05-01-SUMMARY.md

Key existing files:
@src/logic/graphRenderer.ts — GraphConfig, coordinate transforms (pixelToMathX/Y, mathToPixelX/Y), sampleFunction, renderGraph, zoomViewport, panViewport (from Plan 01)
@src/components/GraphPanel.tsx — Canvas with zoom/pan handlers, viewport props (from Plan 01)
@src/components/Calculator.tsx — Graph props pass-through
@src/App.tsx — Graph state management
@src/styles/Calculator.css — Graph panel and controls styles
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trace rendering, table data generation, and trace/table UI</name>
  <files>
    src/logic/graphRenderer.ts
    src/logic/graphRenderer.test.ts
    src/components/GraphPanel.tsx
    src/components/FunctionTable.tsx
    src/components/Calculator.tsx
    src/App.tsx
    src/styles/Calculator.css
  </files>
  <action>
**In `src/logic/graphRenderer.ts`**, add:

1. `evaluateAtX(expression: string, x: number, angleMode: 'DEG' | 'RAD'): number | null` — Evaluates the expression at a single x value. Returns null if evaluation fails or result is non-finite. Uses same scope setup as `sampleFunction` (angle mode overrides, log aliasing). This is extracted from the inner loop of `sampleFunction` for reuse.

2. `renderTracePoint(ctx: CanvasRenderingContext2D, mathX: number, mathY: number, config: GraphConfig): void` — Draws a filled circle (radius 5px, color `#ff6b6b` — contrasting red) at the math coordinate on the canvas. Also draws thin crosshair lines (dashed, same color, 0.5px) from the point to each axis for visual reference.

3. `generateTableData(expression: string, config: GraphConfig, rowCount?: number): Array<{ x: number, y: number | null }>` — Generates `rowCount` (default 21) evenly-spaced x values across current viewport xMin..xMax, evaluates y for each. Returns array of {x, y} pairs. Uses `evaluateAtX` internally.

**In `src/logic/graphRenderer.test.ts`**, add tests:
- `evaluateAtX` returns correct value for `x^2` at x=3 (should be 9)
- `evaluateAtX` returns null for invalid expression
- `evaluateAtX` respects angle mode (sin(90) in DEG = 1, in RAD != 1)
- `generateTableData` returns correct row count (default 21)
- `generateTableData` x values span viewport range (first = xMin, last = xMax)
- `generateTableData` returns null y for undefined points (e.g., `1/x` at x=0)

**In `src/components/GraphPanel.tsx`**:

1. Add trace state: `const [tracePoint, setTracePoint] = useState<{ x: number, y: number, pixelX: number, pixelY: number } | null>(null)`

2. Add `onMouseMove` handler (in addition to existing drag handler):
   - If NOT dragging: convert mouse pixel position to math x using `pixelToMathX`. Evaluate y using `evaluateAtX(expression, mathX, angleMode)`. If y is a valid number and within viewport yMin..yMax, set tracePoint with math and pixel coords. Otherwise set tracePoint to null.
   - If dragging: existing pan behavior takes priority, clear tracePoint.

3. Add `onMouseLeave` handler addition: clear tracePoint (set to null).

4. After calling `renderGraph()` in useEffect, if tracePoint is set and its math coordinates are within current viewport, call `renderTracePoint(ctx, tracePoint.x, tracePoint.y, config)`. Add tracePoint to useEffect dependencies.

5. Add coordinate readout overlay: When tracePoint is set, render a small text element positioned near the canvas (absolute positioned inside `.graph-panel`) showing `x: {value}, y: {value}` formatted to 4 decimal places. Position it at bottom-left of the graph panel as a semi-transparent bar. CSS class: `.graph-panel__trace-readout`.

6. Add "Table" toggle button to the zoom controls bar (next to +/-/Reset). When clicked, it toggles a `showTable` state.

7. Accept new prop: `onTableToggle?: () => void` and `showTable?: boolean` from parent, OR manage table visibility internally in GraphPanel. Since table data depends on expression and viewport (already available as props), manage `showTable` as local state inside GraphPanel.

**In `src/components/FunctionTable.tsx`** (new file):

Create a simple, scrollable table component:
- Props: `data: Array<{ x: number, y: number | null }>`, `visible: boolean`
- Renders a table with two columns: x and y
- x values formatted to 2 decimal places, y values formatted to 4 decimal places (or "undefined" for null)
- Scrollable container with max-height 200px
- Header row: "x" | "f(x)"
- Returns null when not visible
- CSS class: `.function-table`

**In `src/components/Calculator.tsx`**:
- No new props needed if table state is local to GraphPanel
- If FunctionTable is rendered inside GraphPanel, no changes here

**In `src/styles/Calculator.css`**, add:

- `.graph-panel__trace-readout` — Absolute positioned bottom-left of `.graph-panel`, semi-transparent dark background (`rgba(0,0,0,0.75)`), white text, small monospace font (11px), padding 2px 6px, border-radius 3px. `pointer-events: none` so it doesn't interfere with mouse events.

- `.graph-panel__control-btn--active` — Active state for Table toggle button (blue accent background when table is shown).

- `.function-table` — Below graph panel, dark background matching graph (#1a1a1a), border-top for visual separation.
- `.function-table__container` — `max-height: 200px; overflow-y: auto;` for scrolling.
- `.function-table table` — Full width, border-collapse, monospace font.
- `.function-table th` — Sticky top header, background #2a2a2a, color #aaa, padding 4px 8px, text-align right.
- `.function-table td` — Color #ccc, padding 4px 8px, text-align right, border-bottom 1px solid rgba(255,255,255,0.1).
- `.function-table td--undefined` — Color #666, italic for null/undefined values.
- Responsive: On phone (max 480px), reduce font to 0.8rem, padding to 2px 4px.
  </action>
  <verify>
Run `npm test` — all tests pass (existing + new evaluateAtX and generateTableData tests). Run `npm run build` — no TypeScript errors. In browser: hover over plotted curve shows trace dot and coordinate readout, moving mouse away clears trace, Table button shows/hides function table with correct values.
  </verify>
  <done>
Hovering over graph shows trace dot on curve with x,y coordinate readout. Function table is toggleable showing x/y pairs for current viewport. Trace point clears on mouse leave. Table updates when viewport changes via zoom/pan. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Phase 5 graph interactions</name>
  <files>n/a</files>
  <action>
Human verification of all Phase 5 graph interaction features.

**What was built:** Complete graph interaction suite: zoom (wheel + buttons), pan (drag), trace (hover), and function table.

**How to verify:**
1. Start dev server: `npm run dev`
2. Switch to Expression mode, enter `sin(x)` in graph input, click Plot
3. **Zoom test:** Scroll mouse wheel up on graph — should zoom in (axis labels show smaller range). Scroll down — zoom out. Click "+" button — zoom in. Click "-" button — zoom out. Click "Reset" — returns to -10..10.
4. **Pan test:** Click and drag on the graph — viewport should shift. Release — stops. Check that axis labels update to reflect new position.
5. **Trace test:** Move mouse over the sine curve — red dot should appear on the curve tracking mouse x-position. Coordinate readout should show x,y values at bottom of graph. Move mouse off graph — dot and readout disappear.
6. **Table test:** Click "Table" button in graph controls — table appears below graph showing x and f(x) columns with ~21 rows spanning current viewport range. Values should match the plotted function. Zoom in, verify table updates with new range.
7. **Combined test:** Plot `1/x`, zoom into x=0.1..1 range, verify trace shows values, table shows "undefined" at x=0 if visible.
8. **Mobile test:** In browser dev tools, enable touch simulation. Verify touch-drag pans the graph.

**Resume signal:** Type "approved" or describe issues to fix.
  </action>
  <verify>User confirms all interaction features work correctly</verify>
  <done>All Phase 5 graph interactions verified by user: zoom, pan, trace, and function table working as expected</done>
</task>

</tasks>

<verification>
1. `npm test` — All tests pass
2. `npm run build` — Clean build
3. All four Phase 5 success criteria verified:
   - Zoom in/out via wheel + buttons
   - Pan/drag navigation
   - Trace with x,y coordinate display
   - Function table with x/y value pairs
</verification>

<success_criteria>
- Trace dot follows curve as mouse moves horizontally
- Coordinate readout shows x,y formatted to 4 decimal places
- Function table shows 21 rows of x/f(x) pairs for current viewport
- Table updates when viewport changes (zoom/pan adjusts the range)
- All existing graph and calculator tests still pass
- No new TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-graphing-interactions/05-02-SUMMARY.md`
</output>
