---
phase: 05-graphing-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/logic/graphRenderer.ts
  - src/logic/graphRenderer.test.ts
  - src/components/GraphPanel.tsx
  - src/App.tsx
  - src/components/Calculator.tsx
  - src/styles/Calculator.css
autonomous: true

must_haves:
  truths:
    - "User can zoom in on the graph using mouse wheel scroll up or + button"
    - "User can zoom out on the graph using mouse wheel scroll down or - button"
    - "User can pan/drag the graph to navigate different regions"
    - "Graph re-renders with updated viewport bounds after zoom or pan"
    - "Zoom and pan reset button returns to default -10 to 10 viewport"
  artifacts:
    - path: "src/logic/graphRenderer.ts"
      provides: "Updated GraphConfig used dynamically, zoom/pan helper functions"
      contains: "clampViewport"
    - path: "src/components/GraphPanel.tsx"
      provides: "Mouse event handlers for wheel zoom and drag pan, zoom UI controls"
      contains: "onWheel"
    - path: "src/App.tsx"
      provides: "Dynamic viewport state (xMin, xMax, yMin, yMax) replacing hardcoded bounds"
      contains: "graphViewport"
  key_links:
    - from: "src/components/GraphPanel.tsx"
      to: "src/logic/graphRenderer.ts"
      via: "Dynamic viewport passed as GraphConfig"
      pattern: "graphViewport"
    - from: "src/App.tsx"
      to: "src/components/GraphPanel.tsx"
      via: "Viewport state and setter props"
      pattern: "onViewportChange"
---

<objective>
Add zoom and pan interactivity to the graph panel so users can explore different regions and scales of plotted functions.

Purpose: The current graph has hardcoded -10 to 10 bounds. Users need to zoom into areas of interest (e.g., near roots or extrema) and pan to explore regions beyond the default viewport.

Output: Dynamic viewport state, mouse wheel zoom, click-drag pan, zoom +/- buttons, and reset control.
</objective>

<execution_context>
@/Users/angel-ai/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angel-ai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-graphing-core/04-01-SUMMARY.md
@.planning/phases/04-graphing-core/04-02-SUMMARY.md

Key existing files:
@src/logic/graphRenderer.ts — Pure rendering functions with GraphConfig, coordinate transforms, sampleFunction, renderGraph
@src/components/GraphPanel.tsx — React canvas wrapper, currently hardcoded viewport {xMin:-10, xMax:10, yMin:-10, yMax:10}
@src/App.tsx — Graph state: graphExpression, graphInputValue, graphVisible
@src/components/Calculator.tsx — Passes graph props, renders GraphPanel
@src/styles/Calculator.css — .graph-panel, .graph-controls styles
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dynamic viewport state and zoom/pan logic</name>
  <files>
    src/logic/graphRenderer.ts
    src/logic/graphRenderer.test.ts
    src/App.tsx
    src/components/Calculator.tsx
  </files>
  <action>
**In `src/logic/graphRenderer.ts`**, add viewport manipulation helper functions (pure, testable):

1. `zoomViewport(config: GraphConfig, factor: number, centerX: number, centerY: number): { xMin, xMax, yMin, yMax }` — Zooms in/out by `factor` centered on math coordinates (centerX, centerY). Factor < 1 = zoom in, factor > 1 = zoom out. Clamp to prevent zoom below 0.01 range or above 10000 range.

2. `panViewport(config: GraphConfig, dxPixels: number, dyPixels: number): { xMin, xMax, yMin, yMax }` — Pans viewport by pixel delta. Convert pixel delta to math delta using current scale (mathRange / pixelSize). Positive dxPixels = drag right = shift viewport left (subtract from xMin/xMax).

3. `DEFAULT_VIEWPORT = { xMin: -10, xMax: 10, yMin: -10, yMax: 10 }` — Export default bounds constant.

4. `clampViewport(bounds: { xMin, xMax, yMin, yMax }): { xMin, xMax, yMin, yMax }` — Ensures min range of 0.01 and max range of 10000 on each axis. Prevents degenerate viewports.

**In `src/logic/graphRenderer.test.ts`**, add tests:
- `zoomViewport` with factor 0.5 (zoom in) centered at origin: range halves
- `zoomViewport` with factor 2 (zoom out) centered at origin: range doubles
- `zoomViewport` centered off-origin: center point preserved
- `panViewport` with positive dx: viewport shifts left
- `clampViewport` prevents range below 0.01
- `DEFAULT_VIEWPORT` has expected values

**In `src/App.tsx`**:
1. Add state: `const [graphViewport, setGraphViewport] = useState({ xMin: -10, xMax: 10, yMin: -10, yMax: 10 })`
2. Add `handleGraphViewportChange` callback that accepts new viewport bounds and calls `setGraphViewport`
3. Add `handleGraphReset` callback that sets viewport back to `DEFAULT_VIEWPORT` and optionally also clears the graph (call existing handleGraphClear)
4. Reset viewport to DEFAULT_VIEWPORT when `handleGraphClear` is called (add `setGraphViewport(DEFAULT_VIEWPORT)` to existing clear handler)
5. Pass `graphViewport` and `onViewportChange` props to Calculator

**In `src/components/Calculator.tsx`**:
1. Add `graphViewport` and `onViewportChange` to CalculatorProps interface
2. Pass them through to GraphPanel
  </action>
  <verify>
Run `npm test` — all existing tests pass plus new viewport helper tests pass. Run `npm run build` — no TypeScript errors.
  </verify>
  <done>
Viewport helper functions exist and are tested. App.tsx manages dynamic viewport state. GraphPanel receives viewport props (but does not use them yet — that is Task 2).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire zoom/pan interactions and UI controls into GraphPanel</name>
  <files>
    src/components/GraphPanel.tsx
    src/styles/Calculator.css
  </files>
  <action>
**In `src/components/GraphPanel.tsx`**:

1. Accept new props: `viewport: { xMin, xMax, yMin, yMax }`, `onViewportChange: (viewport) => void`

2. Replace hardcoded `xMin:-10, xMax:10, yMin:-10, yMax:10` in the useEffect with `viewport.xMin, viewport.xMax, viewport.yMin, viewport.yMax` from props. Add `viewport` to useEffect dependency array.

3. **Mouse wheel zoom:** Add `onWheel` handler to the canvas element. On wheel event:
   - `e.preventDefault()` to prevent page scroll
   - Calculate mouse position in math coordinates using `pixelToMathX/Y` with current config
   - Determine zoom factor: `e.deltaY > 0 ? 1.2 : 0.8` (scroll down = zoom out, scroll up = zoom in)
   - Call `onViewportChange(zoomViewport(config, factor, mathX, mathY))`
   - Use a `useRef` to store current config so the wheel handler has fresh values without re-attaching

4. **Click-drag pan:** Track drag state with `useRef<{ dragging: boolean, lastX: number, lastY: number }>`.
   - `onMouseDown`: Set dragging=true, record start pixel position. Set `cursor: grabbing` via style.
   - `onMouseMove`: If dragging, calculate pixel delta from last position, call `onViewportChange(panViewport(config, dx, dy))`, update lastX/lastY.
   - `onMouseUp` / `onMouseLeave`: Set dragging=false, reset cursor.
   - Add `touch` equivalents: `onTouchStart`, `onTouchMove`, `onTouchEnd` using `e.touches[0].clientX/Y` for mobile support.

5. **Zoom controls:** Add a small control bar above or overlaid on the canvas with:
   - "+" button: calls `onViewportChange(zoomViewport(config, 0.7, centerX, centerY))` where center is viewport midpoint
   - "-" button: calls `onViewportChange(zoomViewport(config, 1.4, centerX, centerY))`
   - "Reset" button (icon or text): calls `onViewportChange(DEFAULT_VIEWPORT)` to return to -10..10
   - Style these as small, semi-transparent overlay buttons in the top-right corner of the graph panel so they don't obscure the graph.

6. **Canvas cursor:** Set `cursor: grab` on the canvas by default (indicates draggable). Change to `cursor: grabbing` during drag.

**In `src/styles/Calculator.css`**:

Add styles for zoom controls overlay:
- `.graph-panel__controls` — Positioned absolute top-right of `.graph-panel` (which needs `position: relative`). Use `display: flex; gap: 4px;`. Semi-transparent background (`rgba(30,30,30,0.7)`), small padding, rounded corners.
- `.graph-panel__control-btn` — Small square buttons (24x24px), monospace font, border: 1px solid rgba(255,255,255,0.3), background transparent, color white, hover brightens. Cursor pointer.
- Canvas cursor: `.graph-panel__canvas { cursor: grab; }` and `.graph-panel__canvas--dragging { cursor: grabbing; }`
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Run `npm test` — all tests pass. Manually verify in browser: mouse wheel zooms centered on cursor position, click-drag pans the graph, +/- buttons zoom in/out, Reset returns to default viewport. Touch drag works on mobile emulation.
  </verify>
  <done>
Graph responds to mouse wheel zoom (centered on cursor), click-drag pan, and has +/-/Reset overlay controls. Viewport state persists across interactions. Touch events work for mobile. Canvas shows grab cursor.
  </done>
</task>

</tasks>

<verification>
1. `npm test` — All tests pass (existing + new viewport helper tests)
2. `npm run build` — Clean build, no TypeScript errors
3. Plot `sin(x)` — zoom in with mouse wheel, curve shows more detail
4. Plot `x^2` — pan to see the curve at x=20 region
5. Click Reset — viewport returns to -10..10
6. Zoom +/- buttons work
7. Touch drag pans on mobile viewport simulation
</verification>

<success_criteria>
- GraphConfig viewport bounds are dynamic state, not hardcoded
- Mouse wheel zooms centered on cursor position
- Click-drag pans the viewport smoothly
- Touch events support pan on mobile
- Overlay +/-/Reset controls provide button-based zoom
- Viewport resets to -10..10 on clear or reset
- All existing graph tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-graphing-interactions/05-01-SUMMARY.md`
</output>
